{% extends "base.html" %}

{% block title %}Empresas - Alyal{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Empresas monitoradas</h1>

    </div>

    <!-- Formulário de cadastro -->
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>Cadastrar nova empresa</h3>
            <p class="card-description">Preencha os dados de acesso da nova empresa e, se desejar, envie o logotipo para personalizar o painel.</p>
            <form method="post" enctype="multipart/form-data">
                <input type="hidden" name="action" value="create">
                <div class="form-group">
                    <label for="companyUsername">Usuário</label>
                    <input type="text" id="companyUsername" name="username" placeholder="empresa_exemplo" required>
                </div>
                <div class="form-group">
                    <label for="companyEmail">E-mail</label>
                    <input type="email" id="companyEmail" name="email" placeholder="contato@empresa.com" required>
                </div>
                <div class="form-group">
                    <label for="companyPassword">Senha inicial</label>
                    <input type="password" id="companyPassword" name="password" placeholder="Mínimo 6 caracteres" required>
                </div>
                <div class="form-group">
                    <label for="companyPasswordConfirm">Confirmar senha</label>
                    <input type="password" id="companyPasswordConfirm" name="confirm_password" required>
                </div>
                <div class="form-group">
                    <label for="companyLogo">Logotipo (opcional)</label>
                    <input type="file" id="companyLogo" name="logo" accept=".png,.jpg,.jpeg,.gif,.webp">
                    <span class="form-hint">Formatos aceitos: {{ allowed_extensions }} (até 5MB).</span>
                </div>
                <button type="submit" class="btn btn-primary">Adicionar empresa</button>
            </form>
        </div>
    </div>

    <!-- Lista de empresas -->
    <div class="dashboard-card" style="margin-top: 20px;">
        <h3>Empresas cadastradas ({{ companies|length }})</h3>
        <p class="card-description">Clique em uma empresa para gerenciar suas configurações.</p>

        {% if companies %}
            <div class="companies-list" style="margin-top: 20px;">
                {% for company in companies %}
                    <div class="company-item" onclick="openCompanyModal({{ company.id }})">
                        {% if company.logo_filename %}
                            <img src="{{ url_for('static', filename='uploads/logos/' ~ company.logo_filename) }}" alt="Logotipo de {{ company.username }}" class="company-item-logo">
                        {% else %}
                            <div class="company-item-logo-placeholder">{{ company.username[0].upper() }}</div>
                        {% endif %}
                        <div class="company-item-info">
                            <h3>{{ company.username }}</h3>
                            <p>{{ company.email }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; color: var(--text-muted); margin-top: 20px;">Nenhuma empresa cadastrada ainda.</p>
        {% endif %}
    </div>
</div>

<!-- Modal para gerenciar empresa -->
{% for company in companies %}
<div class="modal-overlay" id="modal-{{ company.id }}">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>Configurações da empresa</h2>
            <button type="button" class="modal-close" onclick="closeCompanyModal({{ company.id }})" aria-label="Fechar">×</button>
        </div>

        <div class="modal-body">
            <!-- Informações da empresa -->
            <div class="modal-company-info">
                {% if company.logo_filename %}
                    <img src="{{ url_for('static', filename='uploads/logos/' ~ company.logo_filename) }}" alt="Logotipo de {{ company.username }}" class="modal-company-logo">
                {% else %}
                    <div class="modal-company-logo-placeholder">{{ company.username[0].upper() }}</div>
                {% endif %}
                <div class="modal-company-details">
                    <h3>{{ company.username }}</h3>
                    <p>{{ company.email }}</p>
                </div>
            </div>

            <!-- Atualizar logotipo -->
            <div class="modal-section">
                <h4>Atualizar logotipo</h4>
                <form method="post" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="logo">
                    <input type="hidden" name="user_id" value="{{ company.id }}">
                    <div class="form-group">
                        <label for="logo-{{ company.id }}">Novo logotipo</label>
                        <input type="file" id="logo-{{ company.id }}" name="logo" accept=".png,.jpg,.jpeg,.gif,.webp" required>
                        <span class="form-hint">Formatos aceitos: {{ allowed_extensions }} (até 5MB).</span>
                    </div>
                    <button type="submit" class="btn btn-secondary">Enviar novo logotipo</button>
                </form>
            </div>

            <!-- Atualizar senha -->
            <div class="modal-section">
                <h4>Alterar senha</h4>
                <form method="post">
                    <input type="hidden" name="action" value="password">
                    <input type="hidden" name="user_id" value="{{ company.id }}">
                    <div class="form-group">
                        <label for="new-password-{{ company.id }}">Nova senha</label>
                        <input type="password" id="new-password-{{ company.id }}" name="new_password" placeholder="Mínimo 6 caracteres" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-password-{{ company.id }}">Confirmar nova senha</label>
                        <input type="password" id="confirm-password-{{ company.id }}" name="confirm_password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Atualizar senha</button>
                </form>
            </div>

            <!-- Remover empresa -->
            <div class="modal-section">
                <h4>Zona de perigo</h4>
                <p class="card-description" style="margin-bottom: 16px;">Esta ação não pode ser desfeita. A empresa e seus dados serão removidos permanentemente.</p>
                <form method="post" onsubmit="return confirm('Deseja realmente excluir a empresa {{ company.username }}? Esta ação não pode ser desfeita.');">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="user_id" value="{{ company.id }}">
                    <button type="submit" class="btn btn-danger">Remover empresa</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
// Funções para controlar o modal
function openCompanyModal(companyId) {
    const modal = document.getElementById('modal-' + companyId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeCompanyModal(companyId) {
    const modal = document.getElementById('modal-' + companyId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Fechar modal ao clicar fora do conteúdo
document.addEventListener('DOMContentLoaded', function() {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });

    // Fechar modal com tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal-overlay.active');
            if (activeModal) {
                activeModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
    });
});
</script>
{% endblock %}
