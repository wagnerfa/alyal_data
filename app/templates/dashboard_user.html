{% extends "base.html" %}

{% block title %}Dashboard Usuário - Alyal{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Dashboard do Usuário</h1>
    </div>

    {% set action = url_for('dashboard.user_dashboard') %}
    {% include '_partials/_filters.html' %}

    {% include '_partials/_kpi_cards.html' %}

    <div class="dashboard-grid">
        {% set title = 'Faturamento diário' %}
        {% set canvas_id = 'userRevenueChart' %}
        {% set description = 'Evolução do faturamento considerando pedidos pagos, enviados e entregues.' %}
        {% set height = 220 %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>Status dos pedidos</h3>
            <p class="card-description">Resumo do volume por status no período selecionado.</p>
            <ul class="insights-list">
                {% for item in status_items %}
                    <li><strong>{{ item.label }}</strong>: {{ item.value | decimal_br(0) }}</li>
                {% else %}
                    <li>Nenhum pedido registrado no período.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="dashboard-card insights-card">
            <h3>Resumo do período</h3>
            <ul class="insights-list">
                {% for insight in insights %}
                    <li>{{ insight }}</li>
                {% else %}
                    <li>Importe vendas para visualizar os indicadores.</li>
                {% endfor %}
            </ul>
        </div>

        {% set title = 'Distribuição por status' %}
        {% set canvas_id = 'statusDistributionChart' %}
        {% set description = 'Participação de cada status no período selecionado.' %}
        {% set height = 240 %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-grid">
        {% set title = 'Top 5 produtos por faturamento' %}
        {% set canvas_id = 'topProductsChart' %}
        {% set description = 'Produtos com maior faturamento no período.' %}
        {% set height = 260 %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-grid">
        {% set title = 'Vendas por mês' %}
        {% set canvas_id = 'monthlySalesChart' %}
        {% set description = 'Total de pedidos válidos por mês.' %}
        {% set height = 260 %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-grid">
        {% set title = 'Faturamento por mês' %}
        {% set canvas_id = 'monthlyRevenueChart' %}
        {% set description = 'Soma do faturamento mensal considerando pedidos pagos, enviados e entregues.' %}
        {% set height = 260 %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-card note-card">
        <h3>Comentário do Gestor</h3>
        {% if manager_note %}
            <p class="manager-note-period">Período: {{ start_date.strftime('%d/%m/%Y') }} a {{ end_date.strftime('%d/%m/%Y') }}</p>
            <p>{{ manager_note.conteudo }}</p>
        {% else %}
            <p>Nenhum comentário foi registrado pelo gestor para este período.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const themeStyles = getComputedStyle(document.documentElement);
    const textColor = (themeStyles.getPropertyValue('--text-primary') || '#2c3e50').trim() || '#2c3e50';
    const surfaceColor = (themeStyles.getPropertyValue('--card-bg') || '#ffffff').trim() || '#ffffff';
    const borderTone = (themeStyles.getPropertyValue('--card-border') || 'rgba(0, 0, 0, 0.1)').trim() || 'rgba(0, 0, 0, 0.1)';
    const baseFont = (themeStyles.getPropertyValue('--font-family-base') || '').trim();
    const formatCurrency = (value) => `R$ ${Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

    if (window.Chart) {
        Chart.defaults.color = textColor;
        if (baseFont) {
            Chart.defaults.font.family = baseFont;
        }
    }

    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: textColor,
                    usePointStyle: true
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        },
        layout: { padding: 0 }
    };

    const timeseriesLabels = {{ timeseries_labels|tojson }};
    const timeseriesValues = {{ timeseries_values|tojson }};
    const userCtx = document.getElementById('userRevenueChart');
    if (userCtx && Array.isArray(timeseriesValues) && timeseriesValues.length) {
        new Chart(userCtx, {
            type: 'line',
            data: {
                labels: timeseriesLabels,
                datasets: [{
                    label: 'Faturamento diário',
                    data: timeseriesValues,
                    fill: false,
                    borderColor: '#8082A6',
                    backgroundColor: 'rgba(128, 130, 166, 0.25)',
                    tension: 0.25,
                    borderWidth: 3,
                    pointRadius: 4,
                }]
            },
            options: {
                ...baseOptions,
                plugins: {
                    ...baseOptions.plugins,
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: borderTone }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            callback: (value) => formatCurrency(value)
                        },
                        grid: { color: borderTone }
                    }
                }
            }
        });
    }

    const statusLabels = {{ status_labels|tojson }};
    const statusValues = {{ status_values|tojson }};
    const statusCtx = document.getElementById('statusDistributionChart');
    if (statusCtx && Array.isArray(statusValues) && statusValues.length) {
        const palette = [
            '#8082A6',
            '#34BFA3',
            '#5B9BD5',
            '#F6C23E',
            '#F9A8D4',
            '#ED7D31',
            '#36A2EB'
        ];
        const colors = statusValues.map((_, index) => palette[index % palette.length]);
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: colors,
                    borderColor: surfaceColor || '#ffffff',
                    borderWidth: 1,
                }],
            },
            options: {
                ...baseOptions
            }
        });
    }

    const topProductsLabels = {{ top_products_labels|tojson }};
    const topProductsValues = {{ top_products_values|tojson }};
    const topProductsCtx = document.getElementById('topProductsChart');
    if (topProductsCtx && Array.isArray(topProductsValues) && topProductsValues.length) {
        new Chart(topProductsCtx, {
            type: 'bar',
            data: {
                labels: topProductsLabels,
                datasets: [{
                    label: 'Faturamento',
                    data: topProductsValues,
                    backgroundColor: 'rgba(128, 130, 166, 0.6)',
                    borderColor: '#8082A6',
                    borderWidth: 1.5,
                    maxBarThickness: 36
                }],
            },
            options: {
                ...baseOptions,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            callback: (value) => formatCurrency(value)
                        },
                        grid: { color: borderTone }
                    },
                    y: {
                        ticks: { color: textColor },
                        grid: { color: borderTone }
                    }
                },
                plugins: {
                    ...baseOptions.plugins,
                    legend: { display: false }
                }
            }
        });
    }

    const monthlySalesLabels = {{ monthly_sales_labels|tojson }};
    const monthlySalesValues = {{ monthly_sales_values|tojson }};
    const monthlySalesCtx = document.getElementById('monthlySalesChart');
    if (monthlySalesCtx && Array.isArray(monthlySalesValues) && monthlySalesValues.length) {
        new Chart(monthlySalesCtx, {
            type: 'bar',
            data: {
                labels: monthlySalesLabels,
                datasets: [{
                    label: 'Pedidos válidos',
                    data: monthlySalesValues,
                    backgroundColor: 'rgba(91, 155, 213, 0.6)',
                    borderColor: '#5B9BD5',
                    borderWidth: 1.5,
                    maxBarThickness: 36
                }],
            },
            options: {
                ...baseOptions,
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: borderTone }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            precision: 0
                        },
                        grid: { color: borderTone }
                    }
                },
                plugins: {
                    ...baseOptions.plugins,
                    legend: { display: false }
                }
            }
        });
    }

    const monthlyRevenueLabels = {{ monthly_revenue_labels|tojson }};
    const monthlyRevenueValues = {{ monthly_revenue_values|tojson }};
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart');
    if (monthlyRevenueCtx && Array.isArray(monthlyRevenueValues) && monthlyRevenueValues.length) {
        new Chart(monthlyRevenueCtx, {
            type: 'line',
            data: {
                labels: monthlyRevenueLabels,
                datasets: [{
                    label: 'Faturamento mensal',
                    data: monthlyRevenueValues,
                    fill: true,
                    borderColor: '#34BFA3',
                    backgroundColor: 'rgba(52, 191, 163, 0.2)',
                    tension: 0.25,
                    borderWidth: 2,
                    pointRadius: 4,
                }],
            },
            options: {
                ...baseOptions,
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: borderTone }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            callback: (value) => formatCurrency(value)
                        },
                        grid: { color: borderTone }
                    }
                },
                plugins: {
                    ...baseOptions.plugins,
                    legend: { display: false }
                }
            }
        });
    }
</script>
{% endblock %}
