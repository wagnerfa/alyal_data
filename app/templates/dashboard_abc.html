{% extends "base.html" %}

{% block title %}Curva ABC - Alyal{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Curva ABC por Faturamento</h1>
    </div>

    {% set action = url_for('dashboard.abc_view') %}
    {% include '_partials/_filters.html' %}

    <div class="dashboard-grid">
        {% set title = 'Distribuição de faturamento (Top 10 SKUs)' %}
        {% set canvas_id = 'abcChart' %}
        {% set description = 'Barras exibem faturamento e a linha mostra o acumulado percentual.' %}
        {% include '_partials/_chart_block.html' %}
    </div>

    <div class="dashboard-card">
        <h3>Detalhes por SKU</h3>

        <!-- Controles de pesquisa e info -->
        <div class="table-controls">
            <div class="table-search">
                <input type="text" id="skuSearch" placeholder="Pesquisar por SKU ou nome do produto..." />
            </div>
            <div class="table-info">
                Mostrando <span id="tableCount">0</span> de <span id="tableTotal">0</span> itens
            </div>
        </div>

        <div class="table-responsive">
            <table id="skuTable">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Nome do Produto</th>
                        <th>Faturamento</th>
                        <th>% no total</th>
                        <th>% acumulado</th>
                        <th>Classe</th>
                    </tr>
                </thead>
                <tbody id="skuTableBody">
                    {% for item in abc_data %}
                        <tr class="sku-row" data-sku="{{ item.sku|lower }}" data-nome="{{ item.nome_produto|lower }}">
                            <td data-label="SKU">{{ item.sku }}</td>
                            <td data-label="Nome">{{ item.nome_produto }}</td>
                            <td data-label="Faturamento">{{ item.faturamento|currency_br }}</td>
                            <td data-label="% no total">{{ item.percentual|decimal_br(1) }}%</td>
                            <td data-label="% acumulado">{{ item.percentual_acumulado|decimal_br(1) }}%</td>
                            <td data-label="Classe"><span class="badge badge-class-{{ item.classe|lower }}">{{ item.classe }}</span></td>
                        </tr>
                    {% else %}
                        <tr id="noDataRow">
                            <td colspan="6">Nenhum dado disponível para o período selecionado.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        <div class="table-pagination" id="tablePagination">
            <button id="prevPage" onclick="changePage(-1)">← Anterior</button>
            <span class="page-info">Página <span id="currentPage">1</span> de <span id="totalPages">1</span></span>
            <button id="nextPage" onclick="changePage(1)">Próxima →</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const abcCtx = document.getElementById('abcChart');
    if (abcCtx) {
        new Chart(abcCtx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels|tojson }},
                datasets: [
                    {
                        label: 'Faturamento',
                        data: {{ chart_revenue|tojson }},
                        backgroundColor: 'rgba(175, 169, 217, 0.55)',
                        borderColor: '#AFA9D9',
                        borderWidth: 2,
                        maxBarThickness: 36,
                        yAxisID: 'y',
                    },
                    {
                        type: 'line',
                        label: '% acumulado',
                        data: {{ chart_cumulative|tojson }},
                        borderColor: '#8082A6',
                        backgroundColor: 'rgba(128, 130, 166, 0.2)',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        tension: 0.2,
                        pointRadius: 4,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        ticks: {
                            callback: (value) => `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: (value) => `${value.toFixed(0)}%`
                        },
                        suggestedMax: 100
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    // Paginação e pesquisa da tabela
    let currentPage = 1;
    const rowsPerPage = 20;
    let allRows = [];
    let filteredRows = [];

    document.addEventListener('DOMContentLoaded', function() {
        const skuTableBody = document.getElementById('skuTableBody');
        const noDataRow = document.getElementById('noDataRow');

        // Se não há dados, esconder paginação
        if (noDataRow) {
            document.getElementById('tablePagination').style.display = 'none';
            document.getElementById('tableTotal').textContent = '0';
            document.getElementById('tableCount').textContent = '0';
            return;
        }

        allRows = Array.from(document.querySelectorAll('.sku-row'));
        filteredRows = [...allRows];

        updateTable();

        // Pesquisa
        const searchInput = document.getElementById('skuSearch');
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            if (searchTerm === '') {
                filteredRows = [...allRows];
            } else {
                filteredRows = allRows.filter(row => {
                    const sku = row.getAttribute('data-sku');
                    const nome = row.getAttribute('data-nome');
                    return sku.includes(searchTerm) || nome.includes(searchTerm);
                });
            }

            currentPage = 1;
            updateTable();
        });
    });

    function updateTable() {
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        // Esconder todas as linhas
        allRows.forEach(row => row.style.display = 'none');

        // Mostrar apenas as linhas da página atual
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const rowsToShow = filteredRows.slice(start, end);

        rowsToShow.forEach(row => row.style.display = '');

        // Atualizar informações
        document.getElementById('tableTotal').textContent = totalRows;
        document.getElementById('tableCount').textContent = rowsToShow.length;
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages || 1;

        // Atualizar botões de paginação
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');

        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;

        // Esconder paginação se houver apenas uma página
        if (totalPages <= 1) {
            document.getElementById('tablePagination').style.display = 'none';
        } else {
            document.getElementById('tablePagination').style.display = 'flex';
        }
    }

    function changePage(direction) {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        const newPage = currentPage + direction;

        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            updateTable();

            // Scroll suave para o topo da tabela
            document.getElementById('skuTable').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
</script>
{% endblock %}
